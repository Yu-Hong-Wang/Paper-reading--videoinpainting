# 《ProPainter: Improving Propagation and Transformer for Video Inpainting》

## 研究背景

视频修复：填补视频中的缺失区域，保持时间和空间的一致性。基于光流传播和时空 Transformer 是视频修复中的两种主流机制。问题在于光流未必准确且难以利用到相距较远的帧中的信息，传播方法分别在图像域或特征域中单独进行（本文则将两者结合起来），同时高分辨率和长时间的视频将极大增加计算时间。

## 解决方法

### 双域传播（Dual-Domain Propagation）

**目的**：结合图像域和特征域一起修复视频。

**方法**：在图像域进行全局传播，在特征域进行局部传播。

#### 图像传播
基于光流的扭曲。首先需要检查补全光流的有效性（三个条件：较小一致性误差的像素才会被传播；只考虑掩码区域；只从距离最近的相邻帧传播）。

#### 特征传播
首先从局部序列中提取特征，采用基于光流的可变形对齐模块（使用补全的光流作为基础偏移量，并通过学习偏移量残差来优化它）进行特征传播。

**可变形对齐过程**：
1. 给定当前帧的光流特征 `f_t`（由当前帧的光流 `F_t` 下采样得到）和相邻帧的传播特征 `f_{t+1}^!`，然后进行特征拼接得到 `c(f_t, f_{t+1}^!)`。
2. 利用轻量化的卷积网络预测 DCN 偏移量 `o_{t->t+1}` 和调制掩码 `m_{t->t+1}`：
   - DCN 偏移量表示相邻帧特征在当前帧中的偏移位置。
   - 调制掩码用于调整对齐特征的权重。
3. 使用预测的 DCN 偏移量和调制掩码对相邻帧的传播特征进行可变形卷积对齐，得到对齐特征。
4. 将对齐特征和当前帧的特征 `f_t` 通过卷积层 `R(*)` 进行融合，得到当前帧的传播特征 `f_t^!`。
5. 通过解码器从传播特征 `f_t^!` 中重建**补全**的光流 `F_t^!`。

---

### 掩码引导的稀疏 Transformer

**目的**：用于视频的 Transformer 存在计算和内存密集的情况，并且掩码只占视频中的一小部分，相邻帧之间存在大量的冗余和重复。有人提出了基于窗口的 Transformer，但是仍存在效率问题，本文提出了基于窗口方法的新型稀疏视频 Transformer。

#### 基于窗口的 Transformer
将输入特征划分为多个不重叠的窗口，在每个窗口内独自计算自注意力。同时为了弥补窗口内独自计算的局部性，会引入**窗口拓展策略**或**全局 token** 等策略加强窗口间的信息交互。

#### 软分割操作生成补丁嵌入
将输入图像或视频划分为多个补丁（patch），并将每个补丁映射到一个高维特征空间中。软分割操作通过重叠的滑动窗口来生成补丁嵌入（与硬分割相比可以保留更多的局部信息）。

#### 窗口扩展策略
通过在计算自注意力时扩展窗口的大小，使得每个 token 可以与更多的邻近 token 进行交互，从而促进窗口间交互。

#### 稀疏查询空间
掩码只占视频一小部分。因此我们选择性地对与掩码区域相交的查询窗口应用注意力（具体操作为：判断如果该位置在过去帧中从未包含任何掩码区域，则可以跳过该窗口内的时空注意力）。

#### 稀疏键值空间
相邻帧之间存在高度冗余和重复，没有必要在每个 Transformer 块中包含所有帧作为键/值 token。相反，我们只包含**间隔的时序帧**，在我们的设计中时序跨度为 2。也就是说，在每个奇数编号的 Transformer 块中，只有奇数编号的帧被激活以参与自注意力，而偶数编号的块只包含偶数编号的帧。通过这样做，键和值空间减少了一半，有效降低了 Transformer 模块的计算和内存成本。在根据我们的稀疏策略过滤掉不必要和冗余的窗口后，我们对剩余的窗口执行自注意力以提取细化特征。然后使用软组合操作 [22] 收集这些特征以供后续模块使用。

---

### 循环光流补全网络

**目的**：基于光流的方法是目前比较流行的方法之一，传播像素或者特征可以更好地修复视频，保持时间一致性。但是目前的方法所生成的光流会有积累误差和准确度不高的问题，因此本文提出了独立的光流补全模块，并且兼顾了光流补全的效率。

**方法**：
1. 首先将光流编码为下采样特征。
2. 基于可变形卷积的可变形对齐，从附近的帧全向传播光流信息（具体看可变形对齐过程，见上文）。
3. 使用解码器从传播特征中重建补全的光流。

RFC 采用循环网络实现，能够在长时间范围内保持光流的连贯性。循环网络通过在每个时间步 `t` 传递隐藏状态 `h_t`，从而在视频序列中传播信息。

---

## 待解决的问题

1. **光流补全网络**：能否有新的优化？
2. **自适应光流补全**：结合自适应滤波、卡尔曼滤波等。
3. **双域传播机制**：之后多尺度特征传播。
4. **混合注意力机制**：结合局部和全局注意力机制；动态稀疏注意力机制：根据视频内容及其复杂度动态调整注意力计算范围。
5. **视频超分辨率、视频去噪、视频压缩任务**。
6. **掩码生成方法**。
7. **自监督学习/对抗学习**。

---
