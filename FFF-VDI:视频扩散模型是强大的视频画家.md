# 《Video Diffusion Models are Strong Video Inpainter》

## 研究背景

在缺失区域较大并涉及大幅度运动时，视频修复存在时间一致性的问题，因为模型更多地依赖于光流预测的准确性和目标对象掩码的精确性。同时还存在对象幻觉（预训练的视频扩散模型经常在掩码区域生成不需要的对象）这个问题。本文认为 AVID 等文章通过图像扩散模型填补每一帧，并在推理阶段应用时间一致性模块，然而这些方法**没有考虑**掩码区域的实际像素信息。（？？？我个人对什么是考虑了实际像素存在疑问）

---

## RGVI 解决方法

### 基础知识

- **潜在空间**：通过 encoder (2D-VAE) 将原始图像或视频压缩到一个低维表示空间。
- **噪声潜在代码**：在扩散过程中，每一帧的潜在代码 (latent code) 会被添加噪声，形成噪声潜在代码。
- **DDIM 反转**：将给定的图像或视频帧转换回**噪声潜在代码**，通过 DDIM 反转生成**反转噪声潜在代码**，确保在去噪过程中只填补实际缺失的区域，避免生成不需要的对象（即避免对象幻觉）。
- **可变形卷积网络（DCN）**：可变形卷积允许模型在噪声潜在级别上学习偏移，从而更好地对齐未来帧的信息。

---

### 训练阶段

1. 提取每帧的**潜在代码**，并添加时间步噪声生成**噪声潜在代码**。
2. 将随机掩码帧的未掩码部分通过 2D-VAE 编码器生成**掩码条件潜在掩码**。
3. 将**掩码条件潜在代码**与**噪声潜在代码**沿通道维度连接，并通过卷积层合并为**掩码噪声潜在代码**。
4. 使用光流将未来帧的噪声潜在代码传播到第一帧的噪声潜在代码中，填补第一帧的缺失区域，生成完成的**第一帧噪声潜在代码**。（未来的信息被对齐到第一帧的掩码区域）
5. 使用预训练的 3D-Unet 对噪声潜在代码进行去噪，生成修复后的视频帧。

---

### 测试阶段

**目的**：通过扩散模型的推理过程生成修复后的视频帧。

1. 使用 2D-VAE 编码器将掩码视频帧编码为**掩码条件潜在代码**。这些潜在代码是帧的低维表示，仅包含未掩码区域的信息。
2. 使用 DDIM 反转（DDIM Inversion）过程将掩码条件潜在代码转换为反转噪声潜在代码。
3. 将**反转噪声潜在代码**与随机噪声合并，生成**初始噪声潜在代码**。具体来说，反转噪声潜在代码用于填补掩码区域，而随机噪声用于未掩码区域。
4. 使用光流将未来帧的噪声潜在代码传播到第一帧的噪声潜在代码中，填补第一帧的缺失区域，将未来帧的信息“对齐”到第一帧。
5. 使用预训练的 3D-Unet 对完成的第一帧噪声潜在代码进行去噪，生成修复后的视频帧。
6. 将修复后的视频帧与原始掩码视频帧进行合成，生成最终的修复视频。修复后的视频帧用于填补掩码区域，而原始视频帧的未掩码区域保持不变。

---

### FFF：第一帧填充模块

#### 潜在传播模块（Latent Propagation, LP）

**目的**：使用光流将未来帧的噪声潜在信息传播到第一帧，填补第一帧的掩码区域。

**输入**：未来帧的噪声潜在代码，光流和第一帧的掩码。

**操作**：
- 光流描述了第一帧和未来帧之间的运动关系，将信息 warp 到第一帧。
- 将未来帧的噪声潜在信息仅填补第一帧的掩码区域，而未掩码区域保持不变。

**输出**：传播后的噪声潜在代码包含了未来帧的信息，填补了第一帧的掩码区域。

#### 可变形噪声对齐模块（Deformable Noise Alignment, DNA）

**目的**：通过可变形卷积网络对传播后的噪声潜在代码进行对齐，减少失真并保持时间一致性。

**输入**：传播后的噪声潜在掩码和第一帧掩码。

**操作**：使用可变形卷积（DCN）对传播后的噪声潜在代码进行对齐，在噪声潜在级别上保持时间一致性。

**输出**：**对齐后的噪声潜在代码**，对齐后的噪声潜在代码在噪声潜在级别上保持了时间一致性，减少了失真。

---

## 待解决的问题

1. **运动分割技术**：将复杂运动分解为多个简单的运动分量，分别进行处理。
2. **无光流的视频修复方法**：例如基于注意力机制或时空变换的方法。
3. **视频帧插值技术**：提高帧与帧之间的平滑过渡。

---
